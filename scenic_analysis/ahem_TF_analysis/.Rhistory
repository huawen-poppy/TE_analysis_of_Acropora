library(Seurat)
library(GENIE3)
library(AUCell)
library(RcisTarget)
CC7<-readRDS("/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/seurat_analysis/CC7_raw_data_analysis_extra/data/CC7_after_DEG.RDS")
CC7
Idents(CC7)
unique(CC7$Cell_type)
exprMat <- CC7@assays$RNA@counts
cellinfo <- data.frame(seuratCluster=CC7$Cell_type)
# step 1: gene filtering
minCountsPerGene <- 3*0.01* ncol(exprMat)
exprMat[1:5,1:5]
minSamples <- ncol(exprMat)*0.01
outFile_exprMatTxt <-Null
outFile_exprMatTxt <-NULL
ScenicOptions
ScenicOptions<-initializaScenic(org='CC7',dbDir='/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/scenic_analysis/create_cisTarget_databases',nCoresa=1)
ScenicOptions<-initializeScenic(org='CC7',dbDir='/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/scenic_analysis/create_cisTarget_databases',nCoresa=1)
# initialize settings, import ranking database
library(SCENIC)
ScenicOptions<-initializeScenic(org='CC7',dbDir='/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/scenic_analysis/create_cisTarget_databases',nCoresa=1)
ScenicOptions<-initializeScenic(org='CC7',dbDir='/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/scenic_analysis/create_cisTarget_databases',nCores=1)
library(SCopeLoomR)
library(KernSmooth)
library(BiocParallel)
library(ggplot2)
library(data.table)
library(grid)
library(ComplexHeatmap)
library(Seurat)
library(Seurat)
library(GENIE3)
library(AUCell)
library(RcisTarget)
library(SCENIC)
library(SCopeLoomR)
library(KernSmooth)
library(BiocParallel)
library(ggplot2)
library(data.table)
library(grid)
library(ComplexHeatmap)
CC7<-readRDS("/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/seurat_analysis/CC7_raw_data_analysis_extra/data/CC7_after_DEG.RDS")
CC7
Idents(CC7)
unique(CC7$Cell_type)
library(SeuratDisk)
#convert to h5ad file
SaveH5Seurat(CC7,filename = 'CC7.h5Seurat')
Convert("CC7.h5Seurat",dest="h5ad")
library(SeuratDisk)
as.loom()
?as.loom()
library(Seurat)
library(data.table)
library(SCopeLoomR)
scenicLoomPath='CC7_pyscenic_output.loom'
loom<-open_loom(scenicLoomPath)
# read the information from the loom file
regulons_incidMat <- get_regulons(loom,column.attr.name = 'Regulons')
regulons <- regulosToGeneLists(regulons_incidMat)
regulons <- regulonsToGeneLists(regulons_incidMat)
library(SCENIC)
regulons <- regulonsToGeneLists(regulons_incidMat)
regulonAUC <- get_regulons_AUC(loom,column.attr.name = 'RegulonsAUC')
CC7<-readRDS("/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/seurat_analysis/CC7_raw_data_analysis_extra/data/CC7_after_DEG.RDS")
CC7
library(pheatmap)
n = t(scale(t(getAUC(regulonAUC[,])))) #scale is to the log-ratio
n[n>2]=2
n[n<-2]=-2
n[1:4,1:4]
dim(n)
Idents(CC7)
ac=data.frame(group=as.character(Idents(CC7)))
ac
n=n[,colnames(n) %in% colnames(CC7)]
colnames(CC7)[1:5]
rownames(n)<-colnames(n)
rownames(ac)<-colnames(n)
cg=read.table("./TF_data/aip_TF_list.txt")
cg
dim(n)
cg_n=n[rownames(n) %in% cg,]
dim(cg_n)
cg=read.table("./TF_data/aip_TF_list.txt")[,1] #here can be any TF we want to analyze
cg
cg_n=n[rownames(n) %in% cg,]
dim(cg_n)
rownames(n)[1:5]
rownames(n)<-gsub("(+)","",rownames(n))
cg_n=n[rownames(n) %in% cg,]
dim(cg_n)
rownames(n)[1:5]
rownames(n)<-gsub("(+)","",rownames(n))
rownames(n)[1:5]
n$rowname=rownames(n)
class(n)
n = t(scale(t(getAUC(regulonAUC[,])))) #scale is to the log-ratio number
n[n>2]=2
n[n<-2]=-2
n[1:4,1:4]
dim(n)
rownames(n)[1:5]
rownames(n)<-gsub("(+)","",rownames(n))
rownames(n)[1:5]
n = t(scale(t(getAUC(regulonAUC[,])))) #scale is to the log-ratio number
n[n>2]=2
n[n<-2]=-2
n[1:4,1:4]
dim(n)
n=n[,colnames(n) %in% colnames(CC7)]
rownames(ac)<-colnames(n)
n<-as.data.frame(n)
rownames(n)<-gsub("(+)","",rownames(n))
rownames(n)[1:5]
n[1:4,1:4]
n$rowname<-rownames(n)
n$rowname<-gsub("(+)","",n$rowname)
n$rowname[1:5]
pheatmap(cg_n,show_colnames = F,show_rownames = T,annotation_col = ac)
n = t(scale(t(getAUC(regulonAUC[,])))) #scale is to the log-ratio number
n[n>2]=2
n[n<-2]=-2
n[1:4,1:4]
dim(n)
n=n[,colnames(n) %in% colnames(CC7)]
pheatmap(n,show_colnames = F,show_rownames = T,annotation_col = ac)
Idents(CC7)<-CC7$group
ac=data.frame(group=as.character(Idents(CC7)))
ac
n=n[,colnames(n) %in% colnames(CC7)]
rownames(ac)<-colnames(n)
pheatmap(n,show_colnames = F,show_rownames = T,annotation_col = ac)
View(ac)
a=pheatmap(n,show_colnames = F,show_rownames = T,annotation_col = ac)
save_pheatmap_pdf <- function(x, filename, width=7, height=7) {
stopifnot(!missing(x))
stopifnot(!missing(filename))
pdf(filename, width=width, height=height)
grid::grid.newpage()
grid::grid.draw(x$gtable)
dev.off()
}
save_pheatmap_pdf(a, "pheatmap_group.pdf")
table(ac$group)
dim(n)
ac
library(Seurat)
library(tidyverse)
library(data.table)
library(SCopeLoomR)
library(SCENIC)
scenicLoomPath='CC7_pyscenic_output.loom'
loom<-open_loom(scenicLoomPath)
# read the information from the loom file
regulons_incidMat <- get_regulons(loom,column.attr.name = 'Regulons')
regulons <- regulonsToGeneLists(regulons_incidMat)
regulonAUC <- get_regulons_AUC(loom,column.attr.name = 'RegulonsAUC')
regulonsAucThresholds <- get_regulon_thresholds(loom)
embeddings <- get_embeddings(loom)
loom<-open_loom(scenicLoomPath)
loom<-open_loom(scenicLoomPath,mode = 'r')
scenicLoomPath='./pyscenic_output_file/CC7_pyscenic_output.loom'
loom<-open_loom(scenicLoomPath,mode = 'r')
# read the information from the loom file
regulons_incidMat <- get_regulons(loom,column.attr.name = 'Regulons')
regulons <- regulonsToGeneLists(regulons_incidMat)
regulonAUC <- get_regulons_AUC(loom,column.attr.name = 'RegulonsAUC')
regulonsAucThresholds <- get_regulon_thresholds(loom)
embeddings <- get_embeddings(loom)
exprMat <- get_dgem(loom)
cellInfo <- get_cell_annotation(loom)
clusterings <- get_clusterings_with_name(loom)
close_loom(loom)
# Read table
motifsDf <- data.table::fread("./pyscenic_input_data/aiptasia_motif_true.tbl", header = T, sep="\t")
maxRows <- 20 # (low value only for the tutorial)
# Visualize
tableSubset <- motifsDf[TF=="26571"]
# Visualize
tableSubset <- motifsDf[gene_name=="AIPGENE26571"]
tableSubset <- tableSubset[1:maxRows,]
colnames(motifsDf)
colsToShow <-colnames(motifsDf)
viewMotifs(tableSubset, colsToShow=colsToShow)
# Read table
motifsDf <- data.table::fread("./pyscenic_output_file/reg.csv", header = T, sep="\t")
maxRows <- 20 # (low value only for the tutorial)
head(motifsDf)
# Read table
motifsDf <- data.table::fread("./pyscenic_output_file/reg.csv", header = T, sep=",")
head(motifsDf)
colnames(motifsDf)
View(motifsDf)
# Read table
motifsDf <- data.table::fread("./pyscenic_output_file/reg.csv", header = T, sep="\n")
# Read table
motifsDf <- data.table::fread("./pyscenic_output_file/reg.csv", header = T, sep=",")
# GRNBoost results
GRNBoost_linkList <- importArboreto('./pyscenic_output_file/adj.csv')
head(GRNBoost_linkList)
CC7<-readRDS("/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/seurat_analysis/CC7_raw_data_analysis_extra/data/CC7_after_DEG.RDS")
CC7
library(pheatmap)
n = t(scale(t(getAUC(regulonAUC[,])))) #scale is to the log-ratio number
n[n>2]=2
n[n<-2]=-2
n[1:4,1:4]
dim(n)
Idents(CC7)<-CC7$group
ac=data.frame(group=as.character(Idents(CC7)))
ac
n=n[,colnames(n) %in% colnames(CC7)]
rownames(ac)<-colnames(n)
cd='AIPGENE26571'
cg='AIPGENE26571'
n<-as.data.frame(n)
n$rowname<-rownames(n)
cg_n=n[rownames(n) %in% cg,]
cg='AIPGENE26571(+)'
cg_n=n[rownames(n) %in% cg,]
pheatmap(cg_n,show_colnames = F,show_rownames = T,annotation_col = ac)
ac
cg=c('AIPGENE26571(+)','AIPGENE2519(+)')
cg_n=n[rownames(n) %in% cg,]
pheatmap(cg_n,show_colnames = F,show_rownames = T,annotation_col = ac)
head(regulons)
aucellApp <- plotTsne_AUCellApp(exprMat ) # default t-SNE
?plotTsne_AUCellHtml()
aucellApp <- plotTsne_AUCellApp('./pyscenic_output_file/scenic_umap.txt',exprMat ) # default t-SNE
aucellApp <- plotTsne_AUCellApp(regulons,exprMat ) # default t-SNE
library(Seurat)
library(GENIE3)
library(AUCell)
library(RcisTarget)
CC7<-readRDS("/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/seurat_analysis/CC7_raw_data_analysis_extra/data/CC7_after_DEG.RDS")
CC7
Idents(CC7)
unique(CC7$Cell_type)
library(SeuratDisk)
library(SeuratDisk)
CC7
Assays(CC7)
DefaultAssay(CC7)<-"integrated"
CC7
SaveH5Seurat(CC7,filename = 'CC7_integrated.h5Seurat')
CC7
Convert("CC7_integrated.h5Seurat",dest="h5ad")
CC7_loom<-as.loom(CC7,filename = "CC7_integrated.loom",verbose = F)
CC7_loom$close_all()
library(Seurat)
library(GENIE3)
CC7<-readRDS("/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/seurat_analysis/CC7_raw_data_analysis_extra/data/CC7_after_DEG.RDS")
CC7
# subset the apo and sym groups
Idents(CC7)<-CC7$group
apo<-subset(CC7,idents = "A")
sym<-subset(CC7,idents = "S")
apo
Idents(apo)<-apo$Cell_type
Idents(sym)<-sym$Cell_type
library(SeuratDisk)
apo_loom<-as.loom(apo,filename = 'CC7_apo.loom',verbose = F)
apo_loom$close_all()
sym_loom<-as.loom(sym,filename = 'CC7_sym.loom',verbose = F)
sym_loom$close_all()
#convert to h5ad file
SaveH5Seurat(apo,filename = 'CC7_apo.h5Seurat')
Convert("CC7_apo.h5Seurat",dest="h5ad")
SaveH5Seurat(sym,filename = 'CC7_sym.h5Seurat')
Convert("CC7_sym.h5Seurat",dest="h5ad")
library(Seurat)
library(SCopeLoomR)
CC7<-readRDS("/ibex/scratch/projects/c2101/AipSC_analysis_old_genome/seurat_analysis/CC7_raw_data_analysis_extra/data/CC7_after_DEG.RDS")
##### get the subset of data
DefaultAssay(CC7)<-'RNA'
Idents(CC7)
Idents(CC7)<-CC7$Cell_type
target_celltypes=subset(CC7,subset=c("Immune cell",'Gastrodermal cell','Endosymbiotic cell'))
target_celltypes=subset(CC7,idents=c("Immune cell",'Gastrodermal cell','Endosymbiotic cell'))
target_celltypes$orig.ident[1:5]
target_celltypes_list=SplitObject(target_celltypes,split.by = 'orig.ident')
target_celltypes_list<-lappy(X=target_celltypes_list,FUN=function(x){
x<-NormalizeData(x)
x<-FindVariableFeatures(x,selection.method = 'vst',nfeatures=2000)
})
library(dplyr)
target_celltypes_list<-lappy(X=target_celltypes_list,FUN=function(x){
x<-NormalizeData(x)
x<-FindVariableFeatures(x,selection.method = 'vst',nfeatures=2000)
})
target_celltypes_list<-lapply(X=target_celltypes_list,FUN=function(x){
x<-NormalizeData(x)
x<-FindVariableFeatures(x,selection.method = 'vst',nfeatures=2000)
})
features<-SelectIntegrationFeatures(object.list = target_celltypes_list)
anchors<-FindIntegrationAnchors(object.list = target_celltypes_list,anchor.features = features)
# set k.weight so that it is not larger than the number of cells in the smallest dataset
# https://github.com/satijalab/seurat/issues/3936
target_celltypes_combined1 <- IntegrateData(anchorset = anchors) #k.weight = 46)
DefaultAssay(target_celltypes_combined1) <- "integrated"
target_celltypes_combined1<-ScaleData(target_celltypes_combined1,verbose = FALSE)
target_celltypes_combined1<-RunPCA(target_celltypes_combined1,npcs = 30,verbose = FALSE)
target_celltypes_combined1<-RunUMAP(target_celltypes_combined1,reduction = 'pca',dims = 1:15)
DimPlot(target_celltypes_combined1,group.by = 'orig.ident')
DimPlot(target_celltypes_combined1,group.by = 'Cell_type')
DimPlot(target_celltypes_combined1)
target_celltypes_combined1<-FindNeighbors(target_celltypes_combined1,reduction = 'pca',dims = 1:15)
target_celltypes_combined1<-FindClusters(target_celltypes_combined1,resolution = 0.5)
DimPlot(target_celltypes_combined1)
library(SeuratData)
library(SeuratDisk)
library(SeuratObject)
#convert to h5ad file
SaveH5Seurat(target_celltypes_combined1,filename = 'CC7_subsets.h5Seurat')
Convert("CC7_subsets.h5Seurat",dest="h5ad")
subset_loom<-as.loom(target_celltypes_combined1,filename = 'CC7_subsets.loom',verbose = F)
subset_loom$close_all()
saveRDS(target_celltypes_combined1,"CC7_subsets.RDS")
